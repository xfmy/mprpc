<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: Tinyrpc</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Tinyrpc </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
项目说明</h1>
<p>该项目是在 Linux 环境下基于 muduo、Protobuf 和 Consul 实现的一个轻量级 分布式网络通信RPC 框架。可以把单体架构系统的本地方法调用，重构成基于 TCP 网络通信的 RPC 远程方法调用，实现统一台机器不同进程或者不同机器之间的服务调用。</p>
<h1><a class="anchor" id="autotoc_md2"></a>
项目特点</h1>
<ol type="1">
<li>基于 muduo 网络库实现高并发网络通信模块，作为 RPC 同步调用的基础。</li>
<li>在通讯协议上，采用protobuf实现数据的序列化和反序列化。</li>
<li>设计基于Tcp传输的二进制协议<code>tinypb</code>,解决粘包问题,且能够高效传输服务名、方法名以及参数。并且通过设置消息包id字段防止串包并方便日志追踪,并在不侵入业务代码的情况下可以设置错误码以及错误消息</li>
<li>基于 Consul 分布式协调服务中间件提供服务注册和服务发现功能。</li>
<li>通过<code>RpcController</code>实现客户端的超时机制。</li>
<li>使用线程池做业务处理</li>
</ol>
<h1><a class="anchor" id="autotoc_md3"></a>
项目环境配置</h1>
<ol type="1">
<li>安装<code>muduo</code>网络库</li>
<li>安装序列化<code>protobuf</code></li>
<li>安装配置文件库<code>libconfig</code></li>
<li>安装格式化库<code>libfmt</code></li>
<li>安装consul库<code>ppconsul</code>以及依赖库<code>json11</code>,<code>curl</code></li>
<li>安装<code>cmake</code>以及<code>gcc</code></li>
<li>安装服务注册与发现中间件<code>consul</code></li>
</ol>
<h1><a class="anchor" id="autotoc_md4"></a>
开发环境</h1>
<ul>
<li>ubuntu 22.04</li>
<li>vscode远程</li>
<li>CMake构建项目集成编译环境</li>
<li>Gdb调试</li>
<li>Git版本管理</li>
</ul>
<h1><a class="anchor" id="autotoc_md5"></a>
项目代码工程目录</h1>
<ul>
<li>bin：可执行文件</li>
<li>build：项目编译文件</li>
<li>conf: 配置文件目录</li>
<li>doc: 文档目录</li>
<li>lib：项目库文件</li>
<li>src：源文件</li>
<li>test：测试代码</li>
<li>example：框架代码使用范例</li>
<li>CMakeLists.txt：顶层的cmake文件</li>
<li>README.md：项目自述文件</li>
<li>build.sh：一键编译脚本</li>
<li>.clang-format: clang格式化文件</li>
<li>.gitignore: git过滤文件</li>
</ul>
<h1><a class="anchor" id="autotoc_md6"></a>
构建项目</h1>
<p>运行脚本，其会自动编译项目</p>
<div class="fragment"><div class="line">sh autobuild.sh </div>
</div><!-- fragment --><p>最后会在<code>lib</code>目录下生成<code>libtinyrpc.a</code>rpc静态库文件,以及在<code>bin</code>目录下生成client,service示例程序</p>
<h1><a class="anchor" id="autotoc_md7"></a>
使用示例</h1>
<h3><a class="anchor" id="autotoc_md8"></a>
1.启动consul</h3>
<p>将consul以及服务端的ip,port信息改写入配置文件conf/initConfigFile.conf</p>
<div class="fragment"><div class="line">config = {</div>
<div class="line">    #服务端配置信息</div>
<div class="line">    servicePublicIp = &quot;127.0.0.1&quot;;</div>
<div class="line">    servicePort = &quot;9001&quot;;</div>
<div class="line"> </div>
<div class="line">    #consul配置信息</div>
<div class="line">    consulIp = &quot;127.0.0.1&quot;;</div>
<div class="line">    consulPort = &quot;8500&quot;;</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md9"></a>
2.运行示例程序</h3>
<p>进入bin目录之下</p>
<div class="fragment"><div class="line">#启动服务端</div>
<div class="line">./service ../conf/initConfigFile.conf</div>
<div class="line">#启动客户端</div>
<div class="line">./client ../conf/initConfigFile.conf</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md10"></a>
如何使用</h2>
<p>首先编写<code>protobuf</code>相关代码,如下示例</p>
<div class="fragment"><div class="line">syntax = &quot;proto3&quot;;//声明了protobuf的版本</div>
<div class="line"> </div>
<div class="line">package  fixbug;//声明代码所在位置,对于c++来说是namespace</div>
<div class="line"> </div>
<div class="line">option cc_generic_services = true;</div>
<div class="line"> </div>
<div class="line">//定义登录请求基本类型 name pwd</div>
<div class="line">message LoginRequest</div>
<div class="line">{</div>
<div class="line">    string name = 1;//数字表示第几个参数</div>
<div class="line">    string pwd = 2;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">message ResultCode</div>
<div class="line">{</div>
<div class="line">    int32 errCode = 1;</div>
<div class="line">    string errMsg = 2;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">message LoginResponse</div>
<div class="line">{</div>
<div class="line">    ResultCode result = 1;</div>
<div class="line">    bool sucess  = 2;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">service user</div>
<div class="line">{</div>
<div class="line">    rpc Login(LoginRequest) returns(LoginResponse);</div>
<div class="line">}</div>
</div><!-- fragment --><p>执行命令 protoc protobuf.proto &ndash;cpp_out=OUT_DIR 将会在OUT_DIR目录下生成定义的test.proto文件的cpp代码</p>
<p><img src="https://s2.loli.net/2024/05/02/RsGYP1e9q7Bt86x.png" alt="image-20240502142445631" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md11"></a>
服务端示例</h3>
<p>首先你需要创建个类继承自利用protobuf生成的h文件，然后定义本地对应函数的实现</p>
<p>最后重写基类中的虚函数</p>
<p>在虚函数中主要做几件事情</p>
<ol type="1">
<li>或取请求参数</li>
<li>调用本地对应的方法</li>
<li>通过请求参数获取本地对应的信息</li>
<li>封装响应消息，通过回到用返回给rpcClient端</li>
</ol>
<div class="fragment"><div class="line"><span class="keyword">class </span><a class="code" href="classUserService.html">UserService</a> : <span class="keyword">public</span> <a class="code" href="classfixbug_1_1user.html">fixbug::user</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">bool</span> <a class="code" href="classUserService.html#a0e52624bd7528a7bd4fee67142e959e0">Login</a>(std::string name, std::string password)</div>
<div class="line">    {</div>
<div class="line">        LOG_INFO &lt;&lt; <span class="stringliteral">&quot;user name is &quot;</span> + name;</div>
<div class="line">        LOG_INFO &lt;&lt; <span class="stringliteral">&quot;user password is &quot;</span> + password;</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classUserService.html#a0e52624bd7528a7bd4fee67142e959e0">Login</a>(google::protobuf::RpcController* controller,</div>
<div class="line">                       <span class="keyword">const</span> <a class="code" href="classfixbug_1_1LoginRequest.html">fixbug::LoginRequest</a>* requst,</div>
<div class="line">                       <a class="code" href="classfixbug_1_1LoginResponse.html">fixbug::LoginResponse</a>* response,</div>
<div class="line">                       google::protobuf::Closure* done)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        std::string name = requst-&gt;<a class="code" href="classfixbug_1_1LoginRequest.html#a0d558c1b1df3e7492f4e343af4320393">name</a>();</div>
<div class="line">        std::string password = requst-&gt;<a class="code" href="classfixbug_1_1LoginRequest.html#a1c9c83442517745ffab51092b1b135d1">pwd</a>();</div>
<div class="line">        <span class="keywordtype">int</span> res = <a class="code" href="classUserService.html#a0e52624bd7528a7bd4fee67142e959e0">Login</a>(name, password);</div>
<div class="line">        <a class="code" href="classfixbug_1_1ResultCode.html">fixbug::ResultCode</a>* resCode = response-&gt;<a class="code" href="classfixbug_1_1LoginResponse.html#a07b0923d5c2197a7f001da71ff623479">mutable_result</a>();</div>
<div class="line">        resCode-&gt;<a class="code" href="classfixbug_1_1ResultCode.html#a03343ad6038b30cf355475e2407fbb9f">set_errcode</a>(0);</div>
<div class="line">        resCode-&gt;<a class="code" href="classfixbug_1_1ResultCode.html#af1a81281c9b840fa638c3293ab80cd97">set_errmsg</a>(<span class="stringliteral">&quot;一切正常 very good&quot;</span>);</div>
<div class="line">        response-&gt;<a class="code" href="classfixbug_1_1LoginResponse.html#a4796a84ce39057b18563bcc9af415031">set_sucess</a>(res);</div>
<div class="line">        <span class="comment">//Closure是一个抽象类，</span></div>
<div class="line">        done-&gt;Run();</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="ttc" id="aclassUserService_html"><div class="ttname"><a href="classUserService.html">UserService</a></div><div class="ttdef"><b>Definition:</b> service.cpp:17</div></div>
<div class="ttc" id="aclassUserService_html_a0e52624bd7528a7bd4fee67142e959e0"><div class="ttname"><a href="classUserService.html#a0e52624bd7528a7bd4fee67142e959e0">UserService::Login</a></div><div class="ttdeci">bool Login(std::string name, std::string password)</div><div class="ttdef"><b>Definition:</b> service.cpp:19</div></div>
<div class="ttc" id="aclassfixbug_1_1LoginRequest_html"><div class="ttname"><a href="classfixbug_1_1LoginRequest.html">fixbug::LoginRequest</a></div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:69</div></div>
<div class="ttc" id="aclassfixbug_1_1LoginRequest_html_a0d558c1b1df3e7492f4e343af4320393"><div class="ttname"><a href="classfixbug_1_1LoginRequest.html#a0d558c1b1df3e7492f4e343af4320393">fixbug::LoginRequest::name</a></div><div class="ttdeci">const std::string &amp; name() const</div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:641</div></div>
<div class="ttc" id="aclassfixbug_1_1LoginRequest_html_a1c9c83442517745ffab51092b1b135d1"><div class="ttname"><a href="classfixbug_1_1LoginRequest.html#a1c9c83442517745ffab51092b1b135d1">fixbug::LoginRequest::pwd</a></div><div class="ttdeci">const std::string &amp; pwd() const</div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:691</div></div>
<div class="ttc" id="aclassfixbug_1_1LoginResponse_html"><div class="ttname"><a href="classfixbug_1_1LoginResponse.html">fixbug::LoginResponse</a></div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:402</div></div>
<div class="ttc" id="aclassfixbug_1_1LoginResponse_html_a07b0923d5c2197a7f001da71ff623479"><div class="ttname"><a href="classfixbug_1_1LoginResponse.html#a07b0923d5c2197a7f001da71ff623479">fixbug::LoginResponse::mutable_result</a></div><div class="ttdeci">::fixbug::ResultCode * mutable_result()</div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:880</div></div>
<div class="ttc" id="aclassfixbug_1_1LoginResponse_html_a4796a84ce39057b18563bcc9af415031"><div class="ttname"><a href="classfixbug_1_1LoginResponse.html#a4796a84ce39057b18563bcc9af415031">fixbug::LoginResponse::set_sucess</a></div><div class="ttdeci">void set_sucess(bool value)</div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:920</div></div>
<div class="ttc" id="aclassfixbug_1_1ResultCode_html"><div class="ttname"><a href="classfixbug_1_1ResultCode.html">fixbug::ResultCode</a></div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:238</div></div>
<div class="ttc" id="aclassfixbug_1_1ResultCode_html_a03343ad6038b30cf355475e2407fbb9f"><div class="ttname"><a href="classfixbug_1_1ResultCode.html#a03343ad6038b30cf355475e2407fbb9f">fixbug::ResultCode::set_errcode</a></div><div class="ttdeci">void set_errcode(int32_t value)</div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:756</div></div>
<div class="ttc" id="aclassfixbug_1_1ResultCode_html_af1a81281c9b840fa638c3293ab80cd97"><div class="ttname"><a href="classfixbug_1_1ResultCode.html#af1a81281c9b840fa638c3293ab80cd97">fixbug::ResultCode::set_errmsg</a></div><div class="ttdeci">void set_errmsg(ArgT0 &amp;&amp;arg0, ArgT... args)</div></div>
<div class="ttc" id="aclassfixbug_1_1user_html"><div class="ttname"><a href="classfixbug_1_1user.html">fixbug::user</a></div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:571</div></div>
</div><!-- fragment --><p>然后通过框架启动一个rpc服务</p>
<div class="fragment"><div class="line">RpcApplication::GetInstance().init(argv[1]);</div>
<div class="line">RpcDispatcher provider;</div>
<div class="line">std::shared_ptr&lt;UserService&gt; userService = std::make_shared&lt;UserService&gt;();</div>
<div class="line"><span class="comment">//将你需要的服务可以注册到框架上</span></div>
<div class="line">provider.registerService(userService);</div>
<div class="line">provider.run();</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md12"></a>
调用者示例</h3>
<p>proto文件会自动生成服务端需要的类，也生成了客户端需要的类</p>
<p>调用者需要先调用框架的init方法接受参数，看需要调用哪个rpc服务</p>
<p>然后创建对应Rpc方法提供的stub类的类对象传入框架提供的channel方法，</p>
<p>闯将请求和响应对象，将请求时需要的参数通过protobuf提供的set方法写入到对象中</p>
<p>然后调用stub类对象的相应的方法，响应会通过respons参数传回来</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="CMakeCCompilerId_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (argc != 2)</div>
<div class="line">    {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;启动项参数异常,请检查&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">//初始化框架</span></div>
<div class="line">    RpcApplication::GetInstance().init(argv[1]);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//演示调用远程发布的rpc方法Login</span></div>
<div class="line">    <a class="code" href="classfixbug_1_1user__Stub.html">fixbug::user_Stub</a> stub( <span class="keyword">new</span> RpcChannel());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// rpc参数</span></div>
<div class="line">    <a class="code" href="classfixbug_1_1LoginRequest.html">fixbug::LoginRequest</a> request;</div>
<div class="line">    request.<a class="code" href="classfixbug_1_1LoginRequest.html#a0a65fd0f0f681e44cd89d56c2291c60b">set_name</a>(<span class="stringliteral">&quot;zhang san&quot;</span>);</div>
<div class="line">    request.<a class="code" href="classfixbug_1_1LoginRequest.html#a6ccac5510dc467b7594ee5c6bd8a161a">set_pwd</a>(<span class="stringliteral">&quot;123456&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// rpc的响应</span></div>
<div class="line">    <a class="code" href="classfixbug_1_1LoginResponse.html">fixbug::LoginResponse</a> response;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//发起rpc方法的调用</span></div>
<div class="line">    RpcController control;</div>
<div class="line"> </div>
<div class="line">    stub.Login(&amp;control, &amp;request, &amp;response, <span class="keyword">nullptr</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//一次rpc调用完成，读调用的结果</span></div>
<div class="line">    <span class="comment">//不要直接访问response</span></div>
<div class="line">    <span class="keywordflow">if</span> (control.Failed())</div>
<div class="line">    {</div>
<div class="line">        std::cout &lt;&lt; control.ErrorText() &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (0 == response.<a class="code" href="classfixbug_1_1LoginResponse.html#a2c3d83ae00b75e40d9a1f575a9b28541">result</a>().<a class="code" href="classfixbug_1_1ResultCode.html#a63c91a9fc995acbfce70aa770c912fa8">errcode</a>())</div>
<div class="line">        {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;rpc call success:&quot;</span> &lt;&lt; response.<a class="code" href="classfixbug_1_1LoginResponse.html#a9979d136bf2b2072aa393886b1d2811e">sucess</a>()</div>
<div class="line">                      &lt;&lt; response.<a class="code" href="classfixbug_1_1LoginResponse.html#a2c3d83ae00b75e40d9a1f575a9b28541">result</a>().<a class="code" href="classfixbug_1_1ResultCode.html#a63c91a9fc995acbfce70aa770c912fa8">errcode</a>()</div>
<div class="line">                      &lt;&lt; response.<a class="code" href="classfixbug_1_1LoginResponse.html#a2c3d83ae00b75e40d9a1f575a9b28541">result</a>().<a class="code" href="classfixbug_1_1ResultCode.html#ae9ab6d3f23ba9f2de4892149c40a7257">errmsg</a>() &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;rpc call error:&quot;</span> &lt;&lt; response.<a class="code" href="classfixbug_1_1LoginResponse.html#a2c3d83ae00b75e40d9a1f575a9b28541">result</a>().<a class="code" href="classfixbug_1_1ResultCode.html#ae9ab6d3f23ba9f2de4892149c40a7257">errmsg</a>()</div>
<div class="line">                      &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aCMakeCCompilerId_8c_html_a0ddf1224851353fc92bfbff6f499fa97"><div class="ttname"><a href="CMakeCCompilerId_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a></div><div class="ttdeci">int main(int argc, char *argv[])</div><div class="ttdef"><b>Definition:</b> CMakeCCompilerId.c:776</div></div>
<div class="ttc" id="aclassfixbug_1_1LoginRequest_html_a0a65fd0f0f681e44cd89d56c2291c60b"><div class="ttname"><a href="classfixbug_1_1LoginRequest.html#a0a65fd0f0f681e44cd89d56c2291c60b">fixbug::LoginRequest::set_name</a></div><div class="ttdeci">void set_name(ArgT0 &amp;&amp;arg0, ArgT... args)</div></div>
<div class="ttc" id="aclassfixbug_1_1LoginRequest_html_a6ccac5510dc467b7594ee5c6bd8a161a"><div class="ttname"><a href="classfixbug_1_1LoginRequest.html#a6ccac5510dc467b7594ee5c6bd8a161a">fixbug::LoginRequest::set_pwd</a></div><div class="ttdeci">void set_pwd(ArgT0 &amp;&amp;arg0, ArgT... args)</div></div>
<div class="ttc" id="aclassfixbug_1_1LoginResponse_html_a2c3d83ae00b75e40d9a1f575a9b28541"><div class="ttname"><a href="classfixbug_1_1LoginResponse.html#a2c3d83ae00b75e40d9a1f575a9b28541">fixbug::LoginResponse::result</a></div><div class="ttdeci">const ::fixbug::ResultCode &amp; result() const</div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:833</div></div>
<div class="ttc" id="aclassfixbug_1_1LoginResponse_html_a9979d136bf2b2072aa393886b1d2811e"><div class="ttname"><a href="classfixbug_1_1LoginResponse.html#a9979d136bf2b2072aa393886b1d2811e">fixbug::LoginResponse::sucess</a></div><div class="ttdeci">bool sucess() const</div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:912</div></div>
<div class="ttc" id="aclassfixbug_1_1ResultCode_html_a63c91a9fc995acbfce70aa770c912fa8"><div class="ttname"><a href="classfixbug_1_1ResultCode.html#a63c91a9fc995acbfce70aa770c912fa8">fixbug::ResultCode::errcode</a></div><div class="ttdeci">int32_t errcode() const</div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:748</div></div>
<div class="ttc" id="aclassfixbug_1_1ResultCode_html_ae9ab6d3f23ba9f2de4892149c40a7257"><div class="ttname"><a href="classfixbug_1_1ResultCode.html#ae9ab6d3f23ba9f2de4892149c40a7257">fixbug::ResultCode::errmsg</a></div><div class="ttdeci">const std::string &amp; errmsg() const</div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:765</div></div>
<div class="ttc" id="aclassfixbug_1_1user__Stub_html"><div class="ttname"><a href="classfixbug_1_1user__Stub.html">fixbug::user_Stub</a></div><div class="ttdef"><b>Definition:</b> protobuf.pb.h:604</div></div>
</div><!-- fragment --><p>调用一次打印日志</p>
<div class="fragment"><div class="line">#service</div>
<div class="line">root@VM-16-3-ubuntu:~/projects/mprpc/bin# ./service ../conf/initConfigFile.conf</div>
<div class="line">20250331 14:44:06.634708 388175 INFO  work loop thread start - tcp_server.cpp:97</div>
<div class="line">20250331 14:44:10.840627 388170 INFO  TcpServer::newConnection [networkServer] - new connection [networkServer-0.0.0.0:9001#1] from 127.0.0.1:58676 - TcpServer.cc:80</div>
<div class="line">20250331 14:44:10.840823 388175 INFO  127.0.0.1:58676客户发起来了连接 - tcp_server.cpp:85</div>
<div class="line">20250331 14:44:10.841466 388175 INFO  接收到一个的包 data size:70 - tcp_server.cpp:57</div>
<div class="line">20250331 14:44:10.841654 388175 ERROR parse sericve_name[user] and method_name[Login] from full name [fixbug.user.Login] - rpc_dispatcher.cpp:235</div>
<div class="line">20250331 14:44:10.841715 388175 INFO  79217084| get rpc requestname: &quot;zhang san&quot; pwd: &quot;123456&quot; - rpc_dispatcher.cpp:139</div>
<div class="line">20250331 14:44:10.841817 388175 INFO  user name is zhang san - service.cpp:12</div>
<div class="line">20250331 14:44:10.841855 388175 INFO  user password is 123456 - service.cpp:13</div>
<div class="line">20250331 14:44:10.841891 388175 INFO  79217084| dispatch success, requesut-&gt;name: &quot;zhang san&quot; pwd: &quot;123456&quot;, response-&gt;result { errMsg: &quot;\344\270\200\345\210\207\346\255\243\345\270\270 very good&quot; } sucess: true - rpc_dispatcher.cpp:163</div>
<div class="line">20250331 14:44:10.843297 388175 INFO  127.0.0.1:58676客户断开了连接 - tcp_server.cpp:89</div>
<div class="line">20250331 14:44:10.843378 388170 INFO  TcpServer::removeConnectionInLoop [networkServer] - connection networkServer-0.0.0.0:9001#1 - TcpServer.cc:109</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">#client</div>
<div class="line">root@VM-16-3-ubuntu:~/projects/mprpc/bin# ./client ../conf/initConfigFile.conf</div>
<div class="line">20240502 06:44:10.830904Z 388210 INFO  RpcChannel - rpc_channel.cpp:36</div>
<div class="line">20240502 06:44:10.840230Z 388210 INFO  TcpClient::TcpClient[tcp_client] - connector 0x5606CDC8D750 - TcpClient.cc:69</div>
<div class="line">20240502 06:44:10.840472Z 388210 INFO  TcpClient::connect[tcp_client] - connecting to 127.0.0.1:9001 - TcpClient.cc:107</div>
<div class="line">20240502 06:44:10.840969Z 388210 INFO  79217084| call method name-&gt;fixbug.user.Login - rpc_channel.cpp:97</div>
<div class="line">20240502 06:44:10.841118Z 388210 INFO  79217084 | connect success, peer addr[127.0.0.1:9001] - rpc_channel.cpp:127</div>
<div class="line">20240502 06:44:10.841167Z 388210 INFO  79217084 | send rpc request success. call method name[fixbug.user.Login], peer addr[127.0.0.1:9001] - rpc_channel.cpp:132</div>
<div class="line">20240502 06:44:10.842024Z 388211 INFO  接收到一个的包 data size:79 - tcp_client.cpp:33</div>
<div class="line">20240502 06:44:10.842091Z 388210 INFO  79217084 | success get rpc response, call method name[fixbug.user.Login], peer addr[127.0.0.1:9001] - rpc_channel.cpp:166</div>
<div class="line">20240502 06:44:10.842132Z 388210 INFO  79217084 | call rpc success, call method name[fixbug.user.Login], peer addr[127.0.0.1:9001] - rpc_channel.cpp:194</div>
<div class="line">rpc call success:10一切正常 very good</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md13"></a>
项目解析</h1>
<h2><a class="anchor" id="autotoc_md14"></a>
TinyPB协议</h2>
<p>TinyPB 是 TinyRPC 框架自定义的一种轻量化协议类型，它是基于 google 的 protobuf 而定制的，读者可以按需自行对协议格式进行扩充。</p>
<p><img src="https://s2.loli.net/2024/05/01/e8n1PcKgwGXWbOy.png" alt="image-20240501174650346" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md15"></a>
TinyPB 协议报文格式分解</h3>
<blockquote class="doxtable">
<p><b>TinyPb</b> 协议里面所有的 int 类型的字段在编码时都会先转为**网络字节序**！ </p>
</blockquote>
<div class="fragment"><div class="line"><span class="keyword">class </span>TinyPBProtocol</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span>     PB_START;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span>     PB_END;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    int32_t         packageLen_{0};</div>
<div class="line">    </div>
<div class="line">    int32_t         msgIdLen_{0};</div>
<div class="line">    std::string     msgId_;</div>
<div class="line"> </div>
<div class="line">    int32_t         methodNameLen_{0};</div>
<div class="line">    std::string     methodName_;</div>
<div class="line"> </div>
<div class="line">    int32_t         errorCode_{0};</div>
<div class="line">    int32_t         errorInfoLen_{0};</div>
<div class="line">    std::string     errorInfo_;</div>
<div class="line"> </div>
<div class="line">    std::string     pbData_;</div>
<div class="line">    int32_t         checksum_{0};</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span>            parseSuccess_{<span class="keyword">false</span>};</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md16"></a>
时序图</h2>
<p><img src="https://s2.loli.net/2024/06/06/5YZd8x4gyL3K7tC.jpg" alt="solo-fetchupload-6893165705734529521-7932f433" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md17"></a>
错误码释义文档</h2>
<p>err_code 详细说明如下表：</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"><b>错误码</b>   </th><th class="markdownTableHeadNone"><b>错误代码</b>   </th><th class="markdownTableHeadNone"><b>错误码描述</b>    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ERROR_PEER_CLOSED   </td><td class="markdownTableBodyNone">10000000   </td><td class="markdownTableBodyNone">连接时对端关闭    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ERROR_FAILED_CONNECT   </td><td class="markdownTableBodyNone">10000001   </td><td class="markdownTableBodyNone">连接失败    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ERROR_FAILED_GET_REPLY   </td><td class="markdownTableBodyNone">10000002   </td><td class="markdownTableBodyNone">RPC 调用未收到对端回包数据    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ERROR_FAILED_DESERIALIZE   </td><td class="markdownTableBodyNone">10000003   </td><td class="markdownTableBodyNone">反序列化失败，这种情况一般是 TinyPb 里面的 pb_data 有问题    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ERROR_FAILED_SERIALIZE   </td><td class="markdownTableBodyNone">10000004   </td><td class="markdownTableBodyNone">序列化失败    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ERROR_FAILED_ENCODE   </td><td class="markdownTableBodyNone">10000005   </td><td class="markdownTableBodyNone">编码失败    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ERROR_FAILED_DECODE   </td><td class="markdownTableBodyNone">10000006   </td><td class="markdownTableBodyNone">解码失败    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ERROR_RPC_CALL_TIMEOUT   </td><td class="markdownTableBodyNone">10000007   </td><td class="markdownTableBodyNone">rpc 调用超时    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ERROR_SERVICE_NOT_FOUND   </td><td class="markdownTableBodyNone">10000008   </td><td class="markdownTableBodyNone">service 不存在    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ERROR_METHOD_NOT_FOUND   </td><td class="markdownTableBodyNone">10000009   </td><td class="markdownTableBodyNone">method 不存在 method    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ERROR_PARSE_SERVICE_NAME   </td><td class="markdownTableBodyNone">10000010   </td><td class="markdownTableBodyNone">service name 解析失败    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ERROR_RPC_CHANNEL_INIT   </td><td class="markdownTableBodyNone">10000011   </td><td class="markdownTableBodyNone">rpc channel 初始化失败    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ERROR_RPC_PEER_ADDR   </td><td class="markdownTableBodyNone">10000012   </td><td class="markdownTableBodyNone">rpc 调用时候对端地址异常   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
